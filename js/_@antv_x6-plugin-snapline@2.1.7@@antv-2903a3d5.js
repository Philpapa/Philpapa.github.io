import{l as s}from"./_@antv_x6@2.18.1@@antv-b1d372ee.js";var _=globalThis&&globalThis.__decorate||function(i,t,e,n){var o=arguments.length,a=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,e):n,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")a=Reflect.decorate(i,t,e,n);else for(var f=i.length-1;f>=0;f--)(r=i[f])&&(a=(o<3?r(a):o>3?r(t,e,a):r(t,e))||a);return o>3&&a&&Object.defineProperty(t,e,a),a},$=globalThis&&globalThis.__rest||function(i,t){var e={};for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&t.indexOf(n)<0&&(e[n]=i[n]);if(i!=null&&typeof Object.getOwnPropertySymbols=="function")for(var o=0,n=Object.getOwnPropertySymbols(i);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(i,n[o])&&(e[n[o]]=i[n[o]]);return e};class N extends s.View{get model(){return this.graph.model}get containerClassName(){return this.prefixClassName("widget-snapline")}get verticalClassName(){return`${this.containerClassName}-vertical`}get horizontalClassName(){return`${this.containerClassName}-horizontal`}constructor(t){super();const{graph:e}=t,n=$(t,["graph"]);this.graph=e,this.options=Object.assign({},n),this.offset={x:0,y:0},this.render(),this.disabled||this.startListening()}get disabled(){return this.options.enabled!==!0}enable(){this.disabled&&(this.options.enabled=!0,this.startListening())}disable(){this.disabled||(this.options.enabled=!1,this.stopListening())}setFilter(t){this.options.filter=t}render(){const t=this.containerWrapper=new s.Vector("svg"),e=this.horizontal=new s.Vector("line"),n=this.vertical=new s.Vector("line");t.addClass(this.containerClassName),e.addClass(this.horizontalClassName),n.addClass(this.verticalClassName),t.setAttribute("width","100%"),t.setAttribute("height","100%"),e.setAttribute("display","none"),n.setAttribute("display","none"),t.append([e,n]),this.options.className&&t.addClass(this.options.className),this.container=this.containerWrapper.node}startListening(){this.stopListening(),this.graph.on("node:mousedown",this.captureCursorOffset,this),this.graph.on("node:mousemove",this.snapOnMoving,this),this.model.on("batch:stop",this.onBatchStop,this),this.delegateDocumentEvents({mouseup:"hide",touchend:"hide"})}stopListening(){this.graph.off("node:mousedown",this.captureCursorOffset,this),this.graph.off("node:mousemove",this.snapOnMoving,this),this.model.off("batch:stop",this.onBatchStop,this),this.undelegateDocumentEvents()}onBatchStop({name:t,data:e}){t==="resize"&&this.snapOnResizing(e.cell,e)}captureCursorOffset({view:t,x:e,y:n}){const o=t.getDelegatedView();if(o&&this.isNodeMovable(o)){const a=t.cell.getPosition();this.offset={x:e-a.x,y:n-a.y}}}isNodeMovable(t){return t&&t.cell.isNode()&&t.can("nodeMovable")}getRestrictArea(t){const e=this.graph.options.translating.restrict,n=typeof e=="function"?s.FunctionExt.call(e,this.graph,t):e;return typeof n=="number"?this.graph.transform.getGraphArea().inflate(n):n===!0?this.graph.transform.getGraphArea():n||null}snapOnResizing(t,e){if(this.options.resizing&&!e.snapped&&e.ui&&e.direction&&e.trueDirection){const n=this.graph.renderer.findViewByCell(t);if(n&&n.cell.isNode()){const o=t.getBBox(),a=o.bbox(t.getAngle()),r=a.getTopLeft(),f=a.getBottomRight(),v=s.Angle.normalize(t.getAngle()),P=this.options.tolerance||0;let d,C,O,h,R,x;const c={vertical:0,horizontal:0},L=e.direction,T=e.trueDirection,b=e.relativeDirection;T.indexOf("right")!==-1?c.vertical=f.x:c.vertical=r.x,T.indexOf("bottom")!==-1?c.horizontal=f.y:c.horizontal=r.y,this.model.getNodes().some(l=>{if(this.isIgnored(t,l))return!1;const u=l.getBBox().bbox(l.getAngle()),B=u.getTopLeft(),I=u.getBottomRight(),j={vertical:[B.x,I.x],horizontal:[B.y,I.y]},G={};return Object.keys(j).forEach(D=>{const E=D,W=j[E].map(A=>({position:A,distance:Math.abs(A-c[E])})).filter(A=>A.distance<=P);G[E]=s.ArrayExt.sortBy(W,A=>A.distance)}),d==null&&G.vertical.length>0&&(d=G.vertical[0].position,C=Math.min(a.y,u.y),O=Math.max(f.y,I.y)-C),h==null&&G.horizontal.length>0&&(h=G.horizontal[0].position,R=Math.min(a.x,u.x),x=Math.max(f.x,I.x)-R),d!=null&&h!=null}),this.hide();let z=0,m=0;(h!=null||d!=null)&&(d!=null&&(z=T.indexOf("right")!==-1?d-f.x:r.x-d),h!=null&&(m=T.indexOf("bottom")!==-1?h-f.y:r.y-h));let M=0,w=0;if(v%90===0)v===90||v===270?(M=m,w=z):(M=z,w=m);else{const l=v>=0&&v<90?1:v>=90&&v<180?4:v>=180&&v<270?3:2;h!=null&&d!=null&&(z<m?(m=0,h=void 0):(z=0,d=void 0));const u=s.Angle.toRad(v%90);z&&(M=l===3?z/Math.cos(u):z/Math.sin(u)),m&&(w=l===3?m/Math.cos(u):m/Math.sin(u));const B=l===1||l===3;switch(b){case"top":case"bottom":w=m?m/(B?Math.cos(u):Math.sin(u)):z/(B?Math.sin(u):Math.cos(u));break;case"left":case"right":M=z?z/(B?Math.cos(u):Math.sin(u)):m/(B?Math.sin(u):Math.cos(u));break}}switch(b){case"top":case"bottom":M=0;break;case"left":case"right":w=0;break}const S=this.graph.getGridSize();let g=Math.max(o.width+M,S),y=Math.max(o.height+w,S);e.minWidth&&e.minWidth>S&&(g=Math.max(g,e.minWidth)),e.minHeight&&e.minHeight>S&&(y=Math.max(y,e.minHeight)),e.maxWidth&&(g=Math.min(g,e.maxWidth)),e.maxHeight&&(y=Math.min(y,e.maxHeight)),e.preserveAspectRatio&&(w<M?y=g*(o.height/o.width):g=y*(o.width/o.height)),(g!==o.width||y!==o.height)&&(t.resize(g,y,{direction:L,relativeDirection:b,trueDirection:T,snapped:!0,snaplines:this.cid,restrict:this.getRestrictArea(n)}),O&&(O+=y-o.height),x&&(x+=g-o.width));const p=t.getBBox().bbox(v);d&&Math.abs(p.x-d)>1&&Math.abs(p.width+p.x-d)>1&&(d=void 0),h&&Math.abs(p.y-h)>1&&Math.abs(p.height+p.y-h)>1&&(h=void 0),this.update({verticalLeft:d,verticalTop:C,verticalHeight:O,horizontalTop:h,horizontalLeft:R,horizontalWidth:x})}}}snapOnMoving({view:t,e,x:n,y:o}){const a=t.getEventData(e).delegatedView||t;if(!this.isNodeMovable(a))return;const r=a.cell,f=r.getSize(),v=r.getPosition(),P=new s.Rectangle(n-this.offset.x,o-this.offset.y,f.width,f.height),d=r.getAngle(),C=P.getCenter(),O=P.bbox(d),h=O.getTopLeft(),R=O.getBottomRight(),x=this.options.tolerance||0;let c,L,T,b,z,m,M=0,w=0;if(this.model.getNodes().some(S=>{if(this.isIgnored(r,S))return!1;const g=S.getBBox().bbox(S.getAngle()),y=g.getCenter(),p=g.getTopLeft(),l=g.getBottomRight();return c==null&&(Math.abs(y.x-C.x)<x?(c=y.x,M=.5):Math.abs(p.x-h.x)<x?(c=p.x,M=0):Math.abs(p.x-R.x)<x?(c=p.x,M=1):Math.abs(l.x-R.x)<x?(c=l.x,M=1):Math.abs(l.x-h.x)<x&&(c=l.x),c!=null&&(L=Math.min(O.y,g.y),T=Math.max(R.y,l.y)-L)),b==null&&(Math.abs(y.y-C.y)<x?(b=y.y,w=.5):Math.abs(p.y-h.y)<x?b=p.y:Math.abs(p.y-R.y)<x?(b=p.y,w=1):Math.abs(l.y-R.y)<x?(b=l.y,w=1):Math.abs(l.y-h.y)<x&&(b=l.y),b!=null&&(z=Math.min(O.x,g.x),m=Math.max(R.x,l.x)-z)),c!=null&&b!=null}),this.hide(),b!=null||c!=null){b!=null&&(O.y=b-w*O.height),c!=null&&(O.x=c-M*O.width);const S=O.getCenter(),g=S.x-P.width/2,y=S.y-P.height/2,p=g-v.x,l=y-v.y;(p!==0||l!==0)&&(r.translate(p,l,{snapped:!0,restrict:this.getRestrictArea(a)}),m&&(m+=p),T&&(T+=l)),this.update({verticalLeft:c,verticalTop:L,verticalHeight:T,horizontalTop:b,horizontalLeft:z,horizontalWidth:m})}}isIgnored(t,e){return e.id===t.id||e.isDescendantOf(t)||!this.filter(e)}filter(t){const e=this.options.filter;return Array.isArray(e)?e.some(n=>typeof n=="string"?t.shape===n:t.id===n.id):typeof e=="function"?s.FunctionExt.call(e,this.graph,t):!0}update(t){if(t.horizontalTop){const e=this.graph.localToGraph(new s.Point(t.horizontalLeft,t.horizontalTop)),n=this.graph.localToGraph(new s.Point(t.horizontalLeft+t.horizontalWidth,t.horizontalTop));this.horizontal.setAttributes({x1:this.options.sharp?`${e.x}`:"0",y1:`${e.y}`,x2:this.options.sharp?`${n.x}`:"100%",y2:`${n.y}`,display:"inherit"})}else this.horizontal.setAttribute("display","none");if(t.verticalLeft){const e=this.graph.localToGraph(new s.Point(t.verticalLeft,t.verticalTop)),n=this.graph.localToGraph(new s.Point(t.verticalLeft,t.verticalTop+t.verticalHeight));this.vertical.setAttributes({x1:`${e.x}`,y1:this.options.sharp?`${e.y}`:"0",x2:`${n.x}`,y2:this.options.sharp?`${n.y}`:"100%",display:"inherit"})}else this.vertical.setAttribute("display","none");this.show()}resetTimer(){this.timer&&(clearTimeout(this.timer),this.timer=null)}show(){return this.resetTimer(),this.container.parentNode==null&&this.graph.container.appendChild(this.container),this}hide(){this.resetTimer(),this.vertical.setAttribute("display","none"),this.horizontal.setAttribute("display","none");const t=this.options.clean,e=typeof t=="number"?t:t!==!1?3e3:0;return e>0&&(this.timer=window.setTimeout(()=>{this.container.parentNode!==null&&this.unmount()},e)),this}onRemove(){this.stopListening(),this.hide()}dispose(){this.remove()}}_([s.View.dispose()],N.prototype,"dispose",null);const H=`.x6-widget-snapline {
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  pointer-events: none;
}
.x6-widget-snapline-vertical,
.x6-widget-snapline-horizontal {
  stroke: #2ecc71;
  stroke-width: 1px;
}
`;s.Graph.prototype.isSnaplineEnabled=function(){const i=this.getPlugin("snapline");return i?i.isEnabled():!1};s.Graph.prototype.enableSnapline=function(){const i=this.getPlugin("snapline");return i&&i.enable(),this};s.Graph.prototype.disableSnapline=function(){const i=this.getPlugin("snapline");return i&&i.disable(),this};s.Graph.prototype.toggleSnapline=function(){const i=this.getPlugin("snapline");return i&&i.toggleEnabled(),this};s.Graph.prototype.hideSnapline=function(){const i=this.getPlugin("snapline");return i&&i.hide(),this};s.Graph.prototype.setSnaplineFilter=function(i){const t=this.getPlugin("snapline");return t&&t.setFilter(i),this};s.Graph.prototype.isSnaplineOnResizingEnabled=function(){const i=this.getPlugin("snapline");return i?i.isOnResizingEnabled():!1};s.Graph.prototype.enableSnaplineOnResizing=function(){const i=this.getPlugin("snapline");return i&&i.enableOnResizing(),this};s.Graph.prototype.disableSnaplineOnResizing=function(){const i=this.getPlugin("snapline");return i&&i.disableOnResizing(),this};s.Graph.prototype.toggleSnaplineOnResizing=function(i){const t=this.getPlugin("snapline");return t&&t.toggleOnResizing(i),this};s.Graph.prototype.isSharpSnapline=function(){const i=this.getPlugin("snapline");return i?i.isSharp():!1};s.Graph.prototype.enableSharpSnapline=function(){const i=this.getPlugin("snapline");return i&&i.enableSharp(),this};s.Graph.prototype.disableSharpSnapline=function(){const i=this.getPlugin("snapline");return i&&i.disableSharp(),this};s.Graph.prototype.toggleSharpSnapline=function(i){const t=this.getPlugin("snapline");return t&&t.toggleSharp(i),this};s.Graph.prototype.getSnaplineTolerance=function(){const i=this.getPlugin("snapline");if(i)return i.getTolerance()};s.Graph.prototype.setSnaplineTolerance=function(i){const t=this.getPlugin("snapline");return t&&t.setTolerance(i),this};var V=globalThis&&globalThis.__decorate||function(i,t,e,n){var o=arguments.length,a=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,e):n,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")a=Reflect.decorate(i,t,e,n);else for(var f=i.length-1;f>=0;f--)(r=i[f])&&(a=(o<3?r(a):o>3?r(t,e,a):r(t,e))||a);return o>3&&a&&Object.defineProperty(t,e,a),a};class F extends s.Disposable{constructor(t={}){super(),this.name="snapline",this.options=Object.assign({enabled:!0,tolerance:10},t),s.CssLoader.ensure(this.name,H)}init(t){this.snaplineImpl=new N(Object.assign(Object.assign({},this.options),{graph:t}))}isEnabled(){return!this.snaplineImpl.disabled}enable(){this.snaplineImpl.enable()}disable(){this.snaplineImpl.disable()}toggleEnabled(t){if(t!=null)t!==this.isEnabled()&&(t?this.enable():this.disable());else return this.isEnabled()?this.disable():this.enable(),this}hide(){return this.snaplineImpl.hide(),this}setFilter(t){return this.snaplineImpl.setFilter(t),this}isOnResizingEnabled(){return this.snaplineImpl.options.resizing===!0}enableOnResizing(){return this.snaplineImpl.options.resizing=!0,this}disableOnResizing(){return this.snaplineImpl.options.resizing=!1,this}toggleOnResizing(t){return t!=null?t!==this.isOnResizingEnabled()&&(t?this.enableOnResizing():this.disableOnResizing()):this.isOnResizingEnabled()?this.disableOnResizing():this.enableOnResizing(),this}isSharp(){return this.snaplineImpl.options.sharp===!0}enableSharp(){return this.snaplineImpl.options.sharp=!0,this}disableSharp(){return this.snaplineImpl.options.sharp=!1,this}toggleSharp(t){return t!=null?t!==this.isSharp()&&(t?this.enableSharp():this.disableSharp()):this.isSharp()?this.disableSharp():this.enableSharp(),this}getTolerance(){return this.snaplineImpl.options.tolerance}setTolerance(t){return this.snaplineImpl.options.tolerance=t,this}captureCursorOffset(t){this.snaplineImpl.captureCursorOffset(t)}snapOnMoving(t){this.snaplineImpl.snapOnMoving(t)}dispose(){this.snaplineImpl.dispose(),s.CssLoader.clean(this.name)}}V([s.Disposable.dispose()],F.prototype,"dispose",null);export{F as S};

import{a as axios}from"./_axios@1.6.7@axios-8eaa8064.js";import{m as mapState,b as mapMutations}from"./_vuex@3.6.2@vuex-0d722715.js";import{w as checkFormEnable,x as getLicense,n as normalizeComponent}from"./index-66a898a3.js";import{P as Print}from"./printFn-35418519.js";import{r as renderFormByJson}from"./renderFormByJson-1150cc93.js";import"./_element-ui@2.15.14@element-ui-d6404236.js";import"./_@antv_x6-common@2.0.17@@antv-e9d2c7f8.js";import"./_lodash-es@4.17.21@lodash-es-326016e5.js";import"./_vue@2.7.16@vue-c82c1faf.js";import"./_deepmerge@1.5.2@deepmerge-251d9111.js";import"./_resize-observer-polyfill@1.5.1@resize-observer-polyfill-88ffd6cd.js";import"./_throttle-debounce@1.1.0@throttle-debounce-d93b3c53.js";import"./_babel-helper-vue-jsx-merge-props@2.0.3@babel-helper-vue-jsx-merge-props-72d30afb.js";import"./_normalize-wheel@1.0.1@normalize-wheel-1b789469.js";import"./_async-validator@1.8.5@async-validator-8fabaacf.js";import"./_babel-runtime@6.26.0@babel-runtime-ff8b37cd.js";import"./_core-js@2.6.12@core-js-edebcccf.js";import"./_side-channel@1.0.5@side-channel-2c942eb6.js";import"./_get-intrinsic@1.2.4@get-intrinsic-c09dd1a7.js";import"./_es-errors@1.3.0@es-errors-d863dafe.js";import"./_has-symbols@1.0.3@has-symbols-af84758f.js";import"./_has-proto@1.0.1@has-proto-ed1b0be6.js";import"./_function-bind@1.1.2@function-bind-0a5fc7a8.js";import"./_hasown@2.0.1@hasown-7211ef3d.js";import"./_call-bind@1.0.7@call-bind-90319db2.js";import"./_set-function-length@1.2.1@set-function-length-ac203dfa.js";import"./_define-data-property@1.1.4@define-data-property-c2b4af81.js";import"./_es-define-property@1.0.0@es-define-property-86f51ffb.js";import"./_gopd@1.0.1@gopd-7b0e1986.js";import"./_has-property-descriptors@1.0.2@has-property-descriptors-af639a50.js";import"./_qs@6.11.2@qs-d48efb00.js";import"./_vue-router@3.5.3@vue-router-44f70d6f.js";import"./_nanoid@3.3.7@nanoid-3ec3f908.js";import"./_gm-crypto@0.1.12@gm-crypto-48543d3c.js";import"./_to-arraybuffer@1.0.1@to-arraybuffer-dd910a5e.js";import"./_buffer@5.7.1@buffer-81215e29.js";import"./_base64-js@1.5.1@base64-js-554c8894.js";import"./_ieee754@1.2.1@ieee754-0706f68c.js";import"./_jsbn@1.1.0@jsbn-726a10f4.js";import"./_element-resize-detector@1.2.4@element-resize-detector-0b105688.js";import"./_batch-processor@1.0.0@batch-processor-252a9c8d.js";import"./_@vueuse_core@10.7.2@@vueuse-38acc5bf.js";import"./_@vueuse_shared@10.7.2@@vueuse-98aa9f98.js";import"./_vue-demi@0.14.7@vue-demi-52bac217.js";import"./_v-region@2.3.0@v-region-cb5f6f14.js";import"./_@antv_x6@2.18.1@@antv-4eec9d0e.js";import"./_@antv_x6-geometry@2.0.5@@antv-5981308d.js";import"./_@antv_x6-vue-shape@2.1.2@@antv-7a0d94b2.js";import"./_vuedraggable@2.24.3@vuedraggable-f97e6635.js";import"./_sortablejs@1.10.2@sortablejs-2915de19.js";const reportCard_vue_vue_type_style_index_0_lang="",reportCard_vue_vue_type_style_index_1_scoped_5670d065_lang="",_sfc_main={name:"reportCard",provide(){return{comData:this,regionMap:this.regionMap}},components:{renderFormByJson},data(){return{activeName:"",loading:!1,formList:[],dialogTitle:"\u65B0\u589E",tabData:[],curRow:{},bgkData:[],versionList:{},datsetname_list:[],selectSetname:{},filedsList:{},outreach_id:"",act:"add",outreachform:null,cbInfo:null,slaveId:"",btnLoading:!1,printPaddingList:[],printWidth:0,isEmpty:!1,emptyNote:"",regionMap:{},expireData:{},municipalities:["110000","120000","310000","500000","810000","820000"],vCity:["441900","442000","460400"],debounceTimeout:null}},computed:{...mapState({isPrint:e=>e.form.isPrint,isShowPrintRes:e=>e.form.isShowPrintRes})},watch:{isShowPrintRes:{deep:!0,handler(e){e?(this.$nextTick(()=>{this.printPaddingList=[NaN,NaN],this.controlPadding()}),window.addEventListener("resize",this.controlPadding)):window.removeEventListener("resize",this.controlPadding)}}},mounted(){this.setPrintResShow(!1),this.setPrint(!1),this.formCommunicate(),this.getLicenseInfo(),window.addEventListener("message",e=>{!e.data||(e.data.handle==="save"?this.saveFormCallback(e.data):e.data.handle==="htmlPrint"&&this.generatePrintView(),e.data.flag&&this.formCommunicate(e.data.data))})},methods:{...mapMutations({setPrint:"form/SET_PRINT",setPrintResShow:"form/SET_PRINT_RES"}),controlPadding(){let e=this.$refs.printView.$el,t=Number(e.clientWidth);if(this.printPaddingList.some(i=>isNaN(i)))this.printPaddingList=[40,t-40];else{let i=this.printPaddingList[0]/this.printWidth,l=this.printPaddingList[1]/this.printWidth;this.printPaddingList=[Math.ceil(i*t),Math.floor(l*t)]}this.printWidth=t},formatTooltip(e){return this.printPaddingList.indexOf(e)==1?this.printWidth-e:e},generatePrintView(){this.setPrint(!0),this.setPrintResShow(!0),setTimeout(()=>{const e=this.$refs.printView.$el,t=1083;let a=1,i=e.getBoundingClientRect(),l=this.$refs.printView.$children[0].$children;const o=h=>{h=Array.from(h);let _=[];return h.forEach(C=>{let F=(C==null?void 0:C.$el)||C;F._prevClass.includes("draggable-item-draggable")?_=[..._,...o(F.children||[])]:_.push(F)}),_};o(l).forEach(h=>{let C=h.getBoundingClientRect().y-i.y;h.classList.remove("print_gap"),C>a*t&&(a++,h.classList.add("print_gap"))}),e.style.height="fit-content",e.style.minHeight="100%"},200)},printFn(){Print(this.$refs.printView)},onTabChange(e){let t=this.tabData[Number(e.index)];if(!!this.$refs[t.id]&&(this.act==="add"&&this.activeName===this.slaveId||this.act!=="add"&&this.activeName===this.outreachform.form_id)){let i=this.echoFields(this.tabData[0].data,!1);this.cbInfo.udfmsg&&(i={...i,...this.cbInfo.udfmsg});let l=this.$refs[this.tabData[0].id],o=this.$refs[this.tabData[1].id];Array.isArray(l)&&(l=l[0]),Array.isArray(o)&&(o=o[0]);let m=l?l._setupProxy.formValue:{},h=o?o._setupProxy.formValue:{},_=l?l._setupProxy.formFields:{},C=o?o._setupProxy.formFields:{},F=this.tabData[1].params_list,c={};F.forEach(({zkid:s,fkid:f})=>{if(s in m&&f in h&&!this.$F.isEmpty(m[s])&&this.$F.isEmpty(h[f])){let r=_[s];r&&(r=r.dataset_field);let n=C[f];n&&(n=n.dataset_field),r&&n&&(c[n]=i[r])}}),console.log(c,"insertFields"),this.echoFields(this.tabData[1].data,!0,c)}},onParamsKeyTrans(e){},async addCRB(e){let t=await this.getAddFormInfo(e);const{data:{bus_field:a,form_text:i,id:l,name:o,form_name:m,tableset:h}}=t;let _={};try{_=JSON.parse(i)}catch(C){console.log(C)}if(await this.feedbackTabProperty(_,h),this.setNowCompVal(_,new Date),this.dialogTitle="\u65B0\u589E",this.showFormVisible=!0,_){this.tabData.push({id:e,data:_,name:o||m}),this.activeName=e;let C=this.cbInfo.udfmsg?this.cbInfo.udfmsg:{};this.echoFields(this.tabData[0].data,!0,C)}this.presetData(_.children)},async handleEdit(e){console.log(e,"rowInfo"),this.dialogTitle="\u7F16\u8F91";const t={filter:{dat_id:e.dat_id,form_id:e.form_id}};let a=null;this.$api.customForm.getBusFormInfo(t).then(async i=>{if(i.status===104){const{data:{tableinfo:l,dat_id:o}}=i;if(this.outreach_id=o,this.showFormVisible=!0,a=JSON.parse(i.data.form_text),a){await this.feedbackTabProperty(a,l);let m=i.data.data&&i.data.data[0]||{};this.outreachform=i.data.outreachform,this.tabData.push({id:e.form_id,data:a,name:i.data.form_name||i.data.name}),this.activeName=e.form_id,console.log(m,"fields"),this.echoFields(a,!0,m),this.presetData(a.children)}}else this.$message({type:"warning",message:i.msg})})},moveToErr(){this.$nextTick(()=>{let e=document.getElementsByClassName("is-error");e.length&&(e[0].scrollIntoView({block:"center",behavior:"smooth"}),setTimeout(()=>{e[0].previousElementSibling.querySelector("input")&&e[0].previousElementSibling.querySelector("input").focus()},800))})},save(e,t,a){console.log(this.act,t),console.log(this.outreachform,t),this.outreach_id="";let i=!0,l=[];for(let o in this.tabData){let m=this.tabData[o],h=m.id;if((Array.isArray(this.$refs[h])?this.$refs[h][0]:this.$refs[h]).$refs.formRef.validate(r=>i=r),!i){this.btnLoading=!1,this.moveToErr(),Number(o)===0?this.$message.warning("\u4E3B\u8868\u5355\u4FE1\u606F\u672A\u586B\u5199\u5B8C\u6574"):Number(o)===1&&this.$message.warning("\u5B50\u8868\u5355\u4FE1\u606F\u672A\u586B\u5199\u5B8C\u6574");return}let C=this.echoFields(m.data,!1),F,c;o==0?(F=t&&t.dat_id?"mod":"add",c=["add","caogao"].includes(e)?"":t.dat_id):this.outreachform&&this.outreachform.dat_id?(F="mod",c=this.outreachform.dat_id):(F="add",c="");let s={form_id:m.id,act:F,dat_id:c,data:C,origin:"\u4F20\u67D3\u75C5\u62A5\u544A\u5361"},f=this.echoTableFields(m.data);f=f.map(r=>r.filter(b=>b.act)),f=f.filter(r=>r.length>0),console.log(f,"tableRes"),f.length>0&&(f=f.map(r=>{let n=Object.keys(r[0].data).join(",");return n?r.map(D=>({...D,bus_field:n})):r}),s.table=f.map(r=>({tablemx:r}))),l.push(s)}console.log(l,"resFieldArr"),this.$api.customForm.submitBusForm(l[0]).then(o=>{if(o.status==100){l.length===2?(l[1].data={...l[1].data,outreach_id:o.data.datId},this.$api.customForm.submitBusForm(l[1]).then(h=>{h.status==100?(!this.cbInfo||!this.cbInfo.system)&&this.$message.success({message:h.msg}):(this.$message.warning({message:h.msg}),this.btnLoading=!1)}).catch(()=>{this.btnLoading=!1})):l.length===1&&(!this.cbInfo||!this.cbInfo.system)&&this.$message.success({message:o.msg});let m={dat_id:o.data.datId,form_id:l[0].form_id,fields:l[0].data,act:e};this.saveCbInfo(m,a)}else this.$message.warning({message:o.msg})}).catch(()=>{this.btnLoading=!1})},dSave(){this.debounce(this.save,1e3)(...arguments)},async presetData(e,t){if(Array.isArray(e))for(let a in e){let i=e[a];const{name:l,children:o,props:m}=i;if(l==="dSelect"&&m.datset_id){const{datset_id:h,datset_name:_}=m,C={pageNum:0,pageSize:0,filter:{datset_id:h,datset_name:_}};await this.$api.customForm.getBusDicLst(C).then(F=>{if(F.status===104&&F.data.list){const c=F.data.list.reduce((s,f,r)=>[...s,{value:f.id,label:f.name}],[]);e[a].props.dic=c}})}o&&o.length>0&&await this.presetData(e[a].children,t)}},getBusDicLst(e){const t={pageNum:0,pageSize:0,filter:{...e}};this.$api.customForm.getBusDicLst(t).then(a=>{const{status:i,msg:l}=a;if(i==104)return a;this.$message({type:"warning",message:l})})},async saveCbInfo(e,t){const{cbApi:a,configFields:i}=this.tabData[0].data,{system:l,udfmsg:o,token:m,userId:h}=this.cbInfo;l||(this.showFormVisible=!1,this.btnLoading=!1,this.$router.push({name:"reportList"}));let _={},C={};if(!this.$F.isEmpty(i))for(let s of i)this.$F.isEmpty(s.alias)||(_[s.dataset_field]=s.alias);for(let s in e.fields){let f=e.fields[s];_[s]?C[_[s]]=f:C[s]=f}let F={...o,...t,...C,formId:e.form_id,datId:e.dat_id,act:e.act};console.log(F,"params");const c={headers:{Authorization:m,["X-YH-Gateway-Token"]:m,["X-YH-Gateway-SystemUser-Id"]:h}};axios.post(a,F,c).then(s=>{const{status:f,msg:r}=s.data;f==100?(this.$message.success(r),window.parent.postMessage({flag:t,data:{...s.data,params:F}},"*")):this.$message.warning(r)}).catch(s=>{console.log(s,"err")}).finally(()=>{this.btnLoading=!1})},async getAddFormInfo(e){return await this.$api.customForm.getFormText({id:e}).then(t=>{const{status:a,msg:i}=t;if(a==104)return t;this.$message.warning(i)})},onFormatCAttrs(e){let t={};return e.forEach(a=>{const{key:i,value:l,type:o}=a;if(o==="json"){if(!this.$F.isEmpty(i)&&!this.$F.isEmpty(l)){let m=null;try{m=JSON.parse(l),t[i]=m}catch(h){console.log(h)}}}else!this.$F.isEmpty(i)&&!this.$F.isEmpty(l)&&(t[i]=l)}),t},echoFields(e,t,a){ci(this.act);let i=this;if(!e||Object.keys(e).length<1)return;if(t){let c=Object.keys(a);l.call(this,e,c),console.log(a,"add insert")}else{let c=h.call(this,e)||{};return console.log(c,"res"),c}async function l(c,s){const{isBasic:f,children:r,slots:n,name:b,tag:D}=c;if(!f&&b!=="dActiveTable"&&D!=="table"){const{dataset_field:$,reserve_field:u}=c;let p;if(this.act==="add"&&u&&u in this.cbInfo?p=this.cbInfo[u]:p=a[$],s.includes($)||s.includes(u)){const{attrs:y}=c;let v=this.onFormatCAttrs(y),d;if(["dCascader","dCheckbox"].includes(b))d=p?p.split("|"):[];else if(b==="dRegion")if(p){let w=p.slice(0,2)==="00"?"":p.slice(0,2).concat("0000"),g=p.slice(2,4)==="00"?"":p.slice(0,4).concat("00"),I=p.slice(4,6)==="00"?"":p.slice(0,6);this.vCity.includes(g)&&g!==p&&(I=g);let R=p.length!==9?"":p;d=[w,g,I,R]}else d=[];else b==="dSelect"?v.multiple?d=p?p.split("|"):[]:d=p:b==="dTime"?d=p&&p.slice(0,4)>1901?p:"":d=p;if(b==="dRadio"){const{attachedParams:w,tag:g}=c;g||!w||w.length===0?this.$F.isEmpty(d)||m(c,d):(console.log(c,d,"busObj dRadio"),o.call(this,c,d))}else Array.isArray(d)?d.length!==0&&(c.defVal=d):!this.$F.isEmpty(d)&&(c.defVal=d)}}if(r&&r.length>0)for(let $ in r){let u=r[$];l.call(this,u,s)}if(n&&n.named&&n.named.length)for(let $ in n.named){let u=n.named[$].comDetail;!u||l.call(this,u,s)}}async function o(c,s){const{connect_field:f,props:{dic:r}}=c;let n=[];f?r.find(D=>D.value===s)?(c.defVal=s,n=[c]):n=F(e,f):(c.defVal=s,n=[c]);for(let b of n){const{props:{dic:D},attachedParams:$,id:u}=b;if(!D||D.length===0||!D.find(d=>d.value===s)||(b.defVal=s,!$||$.length===0))continue;let y=$.find(d=>{let w=d.value.split("|");return Array.isArray(b.defVal)?w.some(g=>b.defVal.includes(g)):w.includes(b.defVal)});if(!y)continue;let v={status:"",data:{}};if(this.act==="add"?(v=await this.$api.customForm.getFormText({id:y.formId}),this.slaveId=y.formId):v=await this.$api.customForm.getBusFormInfo({filter:{dat_id:this.outreachform.dat_id,form_id:this.outreachform.form_id}}),console.log(v,"openCard res"),v.data){const{status:d,data:{form_text:w,data:g,name:I,form_name:R}}=v;if(d===104){let S={};try{S=JSON.parse(w)?JSON.parse(w):{}}catch(P){console.log(P)}if(S&&S.id==="basic"){let P={};g&&(P=g[0]),this.echoFields(S,!0,P),ci(`\u526F\u5361\u6570\u636E\uFF1A${JSON.stringify(P)}`),this.tabData.push({id:y.formId,data:S,name:I||R,params_list:y.params_list,cntCompId:u})}}}}}function m(c,s){const{connect_field:f,props:{dic:r}}=c;let n=[];f?r.find(D=>D.value===s)?(c.defVal=s,n=[c]):n=F(e,f):(c.defVal=s,n=[c]);for(let b of n){const{props:{dic:D}}=b;!D.find(u=>u.value===s)||(b.defVal=s)}}function h(c){let s={};const{children:f,isBasic:r}=c;if(!r){const{dataset_field:n,dataset_code:b,reserve_field:D,connect_field:$,name:u,attrs:p,props:{dic:y},slots:v,defVal:d}=c;let w={};if(p.forEach(g=>{const{key:I,value:R,type:S}=g;if(S==="json"){if(!this.$F.isEmpty(I)&&!this.$F.isEmpty(R)){let P=null;try{P=JSON.parse(R),w[I]=P}catch(k){console.log(k)}}}else!this.$F.isEmpty(I)&&!this.$F.isEmpty(R)&&(w[I]=R)}),this.$F.isEmpty(d))$||(n&&(s[n]=""),b&&(s[b]=""));else{let g=JSON.parse(JSON.stringify(d));if(Array.isArray(d))if(u=="dRegion"){let I=d.length;g=I!==0?d[I-1]:""}else g=d.join("|");if($){if(n&&g){s[n]=g;let I=_(c);s={...s,...I}}else if(!n&&g){let I=F(e,$);console.log(I,"identicalCom");let R=I.find(S=>!this.$F.isEmpty(S.dataset_field));if(R){const{dataset_field:S,dataset_code:P}=R;s[S]=g;let k=JSON.parse(JSON.stringify(c));k.dataset_code=P;let N=_(k);s={...s,...N}}}}else n&&(s[n]=g),b&&(s={...s,..._(c)})}if(v&&v.named&&v.named.length)for(let g in v.named){let I=v.named[g].comDetail;if(!I)continue;let R=h.call(this,I);s={...s,...R}}}if(f&&f.length>0)for(let n in f){let b=f[n];if(b.name!=="dActiveTable"){let D=h.call(this,b);s={...s,...D}}}return s}function _(c){let s={};const{dataset_code:f,defVal:r,props:{dic:n},attrs:b,name:D,id:$}=c;if(!f)return s;let u=JSON.parse(JSON.stringify(r));if(Array.isArray(r)&&(u=r.join("|")),["",void 0,null].includes(u))return{[f]:""};if(D==="dRegion")return i.regionMap[$]&&(s[f]=i.regionMap[$].split(" / ").join("|")),s;if(!n)return{[f]:""};if(D==="dCheckbox"){let p=[];n.forEach(y=>{r.includes(y.value)&&p.push(y.label)}),s[f]=p.join("|")}else if(D==="dRadio"){let p=n.find(y=>y.value===u);p&&(s[f]=p.label)}else if(D==="dSelect")if(b.find(y=>y.key==="multiple"&&y.value===!0)){let y=[];n.forEach(v=>{r.includes(v.value)&&y.push(v.label)}),s[f]=y.join("|")}else{let y=n.find(v=>v.value===u);y&&(s[f]=y.label)}else if(D==="dCascader"){let p=C(n);p=p.map(d=>[d.value,d.label]);let y=Object.fromEntries(p),v=r.map(d=>y[d]);s[f]=v.join("|")}return s}function C(c){let s=[];return c.forEach(f=>{let r=JSON.parse(JSON.stringify(f));if(r.children&&r.children.length>=1){let n=C(r.children);delete r.children,s=[...s,r,...n]}else s=[...s,r]}),s}function F(c,s){let f=[];const{isBasic:r,children:n}=c;if(!r){const{connect_field:b}=c;b&&b===s&&(f=[...f,c])}if(n&&n.length>0)for(let b of n)f=[...f,...F(b,s)];return f}},echoTableFields(e){let t=this;return i(e);function i(l){let o=[];const{children:m,isBasic:h}=l;if(!h){console.log(l,"busObj");const{tableInfo:_,dicList:C,children:F,props:{datset_id:c},datList:s,name:f}=l;if(f==="dActiveTable"){let r={},n={};for(let D of F){const{dataset_field:$,id:u,name:p,dataset_code:y,props:{dic:v}}=D;!$&&!y||(!r[u]&&(r[u]={}),$&&(r[u].dataset_field=$),y&&(r[u].dataset_code=y),n[u]=p==="dRegion"?"dRegion":v)}for(let D of C)for(let $ in D){let u=D[$];if(!u)continue;const{originId:p}=u;p&&r[p]&&(r[$]=r[p],n[p]&&(n[$]=n[p]))}let b=_.map((D,$)=>{var y,v,d,w;let u=JSON.parse(JSON.stringify(D));delete u.recognizeId,delete u.addId;let p={};for(let g in u.data)if(r[g]){let I=r[g];if(I.dataset_field){let R;if(n[g]&&n[g]==="dRegion")if(Array.isArray(u.data[g])&&u.data[g].length>0){let S=u.data[g].length;R=u.data[g][S-1]}else R="";else R=Array.isArray(u.data[g])?u.data[g].join("|"):u.data[g];p[I.dataset_field]=R}if(I.dataset_code&&n[g])if(n[g]==="dRegion"){let R=(w=(d=(v=(y=t.regionMap[g])==null?void 0:y.split)==null?void 0:v.call(y," / "))==null?void 0:d.join)==null?void 0:w.call(d,"|");p[I.dataset_code]=R||""}else if(Array.isArray(u.data[g])){let R=[];u.data[g].forEach(S=>{let P=n[g].find(k=>k.value===S);P&&R.push(P.label)}),p[I.dataset_code]=R.join("|")}else{let R=n[g].find(S=>S.value===u.data[g]);R&&(p[I.dataset_code]=R.label)}}return u.datset_id=c,s&&s.length>0&&s[$]&&(u.dat_id=s[$]),u.data=p,u});b&&b.length>0&&(o=[...o,b])}}if(m&&m.length>0)for(let _ in m){let C=m[_],F=i(C);o=[...o,...F]}return o}},clearFormValidate(){this.cbInfo&&this.cbInfo.system?(console.log(this.$postmateChild,"this.postmateChild"),window.parent.postMessage({flag:!0,data:{status:this.act}},"*")):(this.showFormVisible=!1,this.$router.push({name:"reportList"}))},async feedbackTabProperty(e,t){if(!t||t.length===0)return;const{children:a,isBasic:i}=e;if(!i){const{name:l,id:o}=e;if(l==="dActiveTable"){let m=t.find(h=>h.components_id===o);if(m){const{datset_id:h,datset_name:_,id:C}=m;if(this.act!=="add"){let F={outreach_id:this.outreach_id,datset_id:h,form_id:this.curRow.form_id,components_id:o},c={};for(let r of e.children)r.dataset_field&&(c[r.dataset_field]=r);console.log(c,"dicReflect");let f=(await this.$api.customForm.getBusFrmDetTableInfo(F)).data;if(f&&f.length>0){let r=f.map(D=>D.dat_id),n=[],b=[];for(let D of f){let $={},u={};for(let p of e.children){let y=this.$F.copy(p);y.id=this.$F.nanoid(),y.originId=p.id,y.dataset_field=p.dataset_field;let v=D[p.dataset_field]||p.defVal;if(["dCheckbox","dCascader"].includes(y.name))!Array.isArray(v)&&(v=v.split("|"));else if(y.name==="dSelect"){let d=y.attrs.find(w=>w.key==="multiple");d&&d.value===!0&&!Array.isArray(v)&&(v=v.split("|"))}else if(y.name==="dRegion"){let d;if(Array.isArray(v)?v.length>0?d=v[v.length-1]:d="":v.includes("|")?(d=v.split("|"),d.length>0?d=d[d.length-1]:d=""):d=v,d){let w=d.slice(0,2)==="00"?"":d.slice(0,2).concat("0000"),g=d.slice(2,4)==="00"?"":d.slice(0,4).concat("00"),I=d.slice(4,6)==="00"?"":d.slice(0,6);this.vCity.includes(g)&&g!==d&&(I=g);let R=d.length!==9?"":d;v=[w,g,I,R]}else v=[]}else y.name==="dTime"&&v.slice(0,4)<1901&&(v="");$[y.id]=v,u[y.id]=y}n=[...n,{data:$}],b=[...b,u]}e.defVal=n,e.datList=r,e.dicList=b}}e.props.datset_id=h,e.props.datset_name=_,e.props.id=C}}}if(a&&a.length>0)for(let l in a){let o=a[l];await this.feedbackTabProperty(o,t)}},fillPatientInfo(e,t){let{isBasic:a,children:i}=e;if(!a){let{dataset_field:l,slots:o}=e;if(t.hasOwnProperty(l)&&(e.defVal=Array.isArray(e.defVal)?t[l]||[]:t[l]||""),o&&o.named&&o.named.length)for(let m in o.named){let h=o.named[m].comDetail;!h||this.fillPatientInfo(h,t)}}if(i&&i.length>0)for(let l of i)this.fillPatientInfo(l,t)},setNowCompVal(e,t=new Date){let{isBasic:a,children:i}=e;if(!a){const{name:l,props:{isDefNow:o},attrs:m}=e;if(l==="dTime"&&o){let h=m.find(F=>F.key==="type"),_=m.find(F=>F.key==="value-format");if(!h)return;let C=h.value==="datetimerange";t=this.$F.formatTime(new Date,_.value),e.defVal=C?[t,t]:t}}if(i&&i.length>0)for(let l in i){let o=i[l];!o||this.setNowCompVal(o,t)}},editRequired(e,t){const[a,i]=t;let{isBasic:l,children:o}=e;if(!l){let{id:m}=e;m===a&&(e.props.isRequired=i)}if(o&&o.length>0)for(let m of o)this.editRequired(m,t)},initGpDisCdt(e){let{isBasic:t,children:a}=e;if(t){if(a&&a.length>0)for(let l of a)this.initGpDisCdt(l)}else{const{name:l}=e;if(l==="dDraggable"&&a&&a.length>0){let o=this.handleLogic(e)&&e.props.groupDisabled;console.log(o,"logicCdtFlag"),e.props.logicCdtFlag=o;for(let m of a)if(m.name!=="dDraggable"){let{slots:h}=m;if(m.props.logicCdtFlag=o,h&&h.named&&h.named.length>0)for(let _ of h.named)i(_,o)}else this.initGpDisCdt(m)}}function i(l,o){let{comDetail:m}=l;if(!m)return;let{slots:h}=m;if(l.comDetail.props.logicCdtFlag=o,h&&h.named&&h.named.length>0)for(let _ of h.named)i(_,o)}},handleLogic(com){const{props:{gpDisCdtGp}}=com;if(console.log(gpDisCdtGp,"gpDisCdtGp"),!gpDisCdtGp||gpDisCdtGp.length===0||gpDisCdtGp.length===1&&!Object.values(gpDisCdtGp[0]).some(t=>t))return!0;let logicStr="",logicReflect={and:"&&",or:"||"};for(let idx in gpDisCdtGp){let val=gpDisCdtGp[idx];const{key,label,logicOp}=val;let itemStr="";if(idx!=gpDisCdtGp.length-1)if(this.$F.isEmpty(key)||this.$F.isEmpty(label)||this.$F.isEmpty(logicOp))itemStr="false&&";else{let keyVal=this.cbInfo?this.$F.isEmpty(this.cbInfo[key])?!0:this.cbInfo[key]:!0;if(keyVal===!0)itemStr="false&&";else{let evalRes=`'${keyVal}'=='${label}'`;console.log(evalRes,"evalRes");try{evalRes=eval(evalRes)}catch(e){console.log(e)}itemStr=`${evalRes}${logicReflect[logicOp]}`}}else if(this.$F.isEmpty(key)||this.$F.isEmpty(label))itemStr="false";else if(this.cbInfo)if(this.cbInfo.hasOwnProperty(key)){let keyVal=this.cbInfo[key],evalRes=`'${keyVal}'=='${label}'`;try{evalRes=eval(evalRes)}catch(e){console.log(e)}itemStr=`${evalRes}`}else itemStr="false";else itemStr="false";logicStr+=itemStr}try{logicStr=eval(logicStr)}catch(e){console.log(e)}if(typeof logicStr=="boolean")return logicStr},async formCommunicate(e){console.log(this.$route.params.cbInfo,"\u8DEF\u7531\u53C2\u6570cbInfo");let t={},a=this.$route.params.cbInfo||{};if(e){let _=e.split("&");for(let C of _){let F=C.split("=");t[F[0]]=decodeURIComponent(F[1])}t.udfmsg=JSON.parse(t.udfmsg),a=t,console.log(t,"cbParamsObj")}if(console.log(a,"cbInfo"),Object.keys(a).length===0)return;const{id:i,act:l,dat_id:o,udfmsg:m,system:h}=a;if(this.cbInfo={...this.cbInfo,...a},h&&(this.cbInfo={...this.cbInfo,...m}),this.act=l,this.curRow={dat_id:o,form_id:i},l==="add"){if(await checkFormEnable(i).then(_=>{this.isEmpty=!1,this.emptyNote="",console.log(_,"is enable ?")}).catch(_=>{this.isEmpty=!0,this.emptyNote=_,console.log(_,"err")}),this.isEmpty)return;this.addCRB(i)}else["mod","view"].includes(l)&&this.handleEdit(this.curRow)},saveFormCallback(e){console.log(e,"data in saveFormCallback"),this.save(this.act,this.curRow,e.params)},getLicenseInfo(){getLicense().then(e=>{console.log(e);const{status:t,data:a}=e;t===100&&(this.expireData=a)})},debounce(e,t,a){var i=this;return function(){var l=arguments,o=function(){i.debounceTimeout=null,a||e.apply(i,l)},m=a&&!i.debounceTimeout;clearTimeout(i.debounceTimeout),i.debounceTimeout=setTimeout(o,t),m&&e.apply(i,l)}}}};var _sfc_render=function e(){var t=this,a=t._self._c;return a("div",{staticClass:"container"},[t.isEmpty?a("div",{staticStyle:{height:"100%",display:"flex","justify-content":"center","align-items":"center"}},[a("div",{staticStyle:{"font-size":"30px",padding:"8px"}},[t._v(t._s(t.emptyNote))]),a("el-button",{staticStyle:{"margin-left":"8px"},attrs:{size:"small"},on:{click:t.clearFormValidate}},[t._v("\u8FD4\u56DE")])],1):a("div",{directives:[{name:"show",rawName:"v-show",value:!t.isShowPrintRes,expression:"!isShowPrintRes"}],staticClass:"busForm"},[t.expireData.type===1?a("div",{staticClass:"expire-note"},[a("i",{staticClass:"el-icon-my-noteInfo",staticStyle:{"margin-right":"8px",color:"#007aff","font-size":"14px"}}),a("span",[t._v(t._s(t.expireData.content))])]):t._e(),t.tabData.length>1?a("el-tabs",{attrs:{type:"card"},on:{"tab-click":t.onTabChange},model:{value:t.activeName,callback:function(i){t.activeName=i},expression:"activeName"}},t._l(t.tabData,function(i){return a("el-tab-pane",{key:i.id,attrs:{label:i.name,name:i.id}},[a("renderFormByJson",{key:i.id,ref:i.id,refInFor:!0,attrs:{data:i.data,isFirst:!0,disabled:t.act==="view"},on:{fillPatientInfo:l=>{t.fillPatientInfo(i.data,l)},editRequired:l=>{t.editRequired(i.data,l)}}})],1)}),1):t.tabData.length==1?a("renderFormByJson",{key:t.tabData[0].id,ref:t.tabData[0].id,attrs:{data:t.tabData[0].data,isFirst:!0,disabled:t.act==="view"},on:{fillPatientInfo:i=>{t.fillPatientInfo(t.tabData[0].data,i)},editRequired:i=>{t.editRequired(t.tabData[0].data,i)}}}):t._e(),t.act!=="view"&&t.cbInfo&&(!t.cbInfo.system||t.cbInfo.system&&t.cbInfo.showSaveBtn)?a("div",{staticClass:"footer-btn"},[t.dialogTitle==="\u65B0\u589E"?a("el-button",{attrs:{type:"primary",size:"small",loading:t.btnLoading},on:{click:function(i){return t.dSave("add")}}},[t._v("\u786E\u5B9A")]):t._e(),t.dialogTitle==="\u7F16\u8F91"?a("el-button",{attrs:{type:"primary",size:"small",loading:t.btnLoading},on:{click:function(i){return t.dSave("mod",t.curRow)}}},[t._v("\u786E\u5B9A")]):t._e(),a("el-button",{attrs:{size:"small"},on:{click:t.clearFormValidate}},[t._v("\u53D6\u6D88")])],1):t._e()],1),t.isShowPrintRes?a("div",{staticClass:"print-section"},[a("div",{staticClass:"tool"},[a("el-button",{on:{click:()=>{t.setPrintResShow(!1),t.setPrint(!1)}}},[t._v("\u8FD4\u56DE")]),a("el-button",{attrs:{type:"primary"},on:{click:t.printFn}},[t._v("\u6253\u5370")])],1),a("div",{staticStyle:{display:"inline-block"},attrs:{id:"canvasCon"}}),a("el-slider",{style:{width:`${t.printWidth}px`},attrs:{"format-tooltip":t.formatTooltip,range:"","show-stops":"",max:t.printWidth},model:{value:t.printPaddingList,callback:function(i){t.printPaddingList=i},expression:"printPaddingList"}}),t.tabData[0]?a("renderFormByJson",{ref:"printView",style:{padding:`0 ${t.printWidth-t.printPaddingList[1]}px 0 ${t.printPaddingList[0]}px`},attrs:{id:"printCon",data:t.tabData[0].data}}):t._e()],1):t._e()])},_sfc_staticRenderFns=[],__component__=normalizeComponent(_sfc_main,_sfc_render,_sfc_staticRenderFns,!1,null,"5670d065",null,null);const reportCard=__component__.exports;export{reportCard as default};

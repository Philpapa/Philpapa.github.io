import{l as d}from"./_@antv_x6@2.18.1@@antv-4eec9d0e.js";d.Graph.prototype.isHistoryEnabled=function(){const h=this.getPlugin("history");return h?h.isEnabled():!1};d.Graph.prototype.enableHistory=function(){const h=this.getPlugin("history");return h&&h.enable(),this};d.Graph.prototype.disableHistory=function(){const h=this.getPlugin("history");return h&&h.disable(),this};d.Graph.prototype.toggleHistory=function(h){const t=this.getPlugin("history");return t&&t.toggleEnabled(h),this};d.Graph.prototype.undo=function(h){const t=this.getPlugin("history");return t&&t.undo(h),this};d.Graph.prototype.redo=function(h){const t=this.getPlugin("history");return t&&t.redo(h),this};d.Graph.prototype.undoAndCancel=function(h){const t=this.getPlugin("history");return t&&t.cancel(h),this};d.Graph.prototype.canUndo=function(){const h=this.getPlugin("history");return h?h.canUndo():!1};d.Graph.prototype.canRedo=function(){const h=this.getPlugin("history");return h?h.canRedo():!1};d.Graph.prototype.cleanHistory=function(h){const t=this.getPlugin("history");return t&&t.clean(h),this};d.Graph.prototype.getHistoryStackSize=function(){return this.getPlugin("history").getSize()};d.Graph.prototype.getUndoStackSize=function(){return this.getPlugin("history").getUndoSize()};d.Graph.prototype.getRedoStackSize=function(){return this.getPlugin("history").getRedoSize()};d.Graph.prototype.getUndoRemainSize=function(){return this.getPlugin("history").getUndoRemainSize()};var y=globalThis&&globalThis.__decorate||function(h,t,e,s){var n=arguments.length,r=n<3?t:s===null?s=Object.getOwnPropertyDescriptor(t,e):s,i;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(h,t,e,s);else for(var a=h.length-1;a>=0;a--)(i=h[a])&&(r=(n<3?i(r):n>3?i(t,e,r):i(t,e))||r);return n>3&&r&&Object.defineProperty(t,e,r),r};class g extends d.Basecoat{constructor(t={}){super(),this.name="history",this.batchCommands=null,this.batchLevel=0,this.lastBatchIndex=-1,this.freezed=!1,this.stackSize=0,this.handlers=[];const{stackSize:e=0}=t;this.stackSize=e,this.options=l.getOptions(t),this.validator=new g.Validator({history:this,cancelInvalid:this.options.cancelInvalid})}init(t){this.graph=t,this.model=this.graph.model,this.clean(),this.startListening()}isEnabled(){return!this.disabled}enable(){this.disabled&&(this.options.enabled=!0)}disable(){this.disabled||(this.options.enabled=!1)}toggleEnabled(t){return t!=null?t!==this.isEnabled()&&(t?this.enable():this.disable()):this.isEnabled()?this.disable():this.enable(),this}undo(t={}){if(!this.disabled){const e=this.undoStack.pop();e&&(this.revertCommand(e,t),this.redoStack.push(e),this.notify("undo",e,t))}return this}redo(t={}){if(!this.disabled){const e=this.redoStack.pop();e&&(this.applyCommand(e,t),this.undoStackPush(e),this.notify("redo",e,t))}return this}cancel(t={}){if(!this.disabled){const e=this.undoStack.pop();e&&(this.revertCommand(e,t),this.redoStack=[],this.notify("cancel",e,t))}return this}getSize(){return this.stackSize}getUndoRemainSize(){const t=this.undoStack.length;return this.stackSize-t}getUndoSize(){return this.undoStack.length}getRedoSize(){return this.redoStack.length}canUndo(){return!this.disabled&&this.undoStack.length>0}canRedo(){return!this.disabled&&this.redoStack.length>0}clean(t={}){return this.undoStack=[],this.redoStack=[],this.notify("clean",null,t),this}get disabled(){return this.options.enabled!==!0}validate(t,...e){return this.validator.validate(t,...e),this}startListening(){this.model.on("batch:start",this.initBatchCommand,this),this.model.on("batch:stop",this.storeBatchCommand,this),this.options.eventNames&&this.options.eventNames.forEach((t,e)=>{this.handlers[e]=this.addCommand.bind(this,t),this.model.on(t,this.handlers[e])}),this.validator.on("invalid",t=>this.trigger("invalid",t))}stopListening(){this.model.off("batch:start",this.initBatchCommand,this),this.model.off("batch:stop",this.storeBatchCommand,this),this.options.eventNames&&(this.options.eventNames.forEach((t,e)=>{this.model.off(t,this.handlers[e])}),this.handlers.length=0),this.validator.off("invalid")}createCommand(t){return{batch:t?t.batch:!1,data:{}}}revertCommand(t,e){this.freezed=!0;const s=Array.isArray(t)?l.sortBatchCommands(t):[t];for(let n=s.length-1;n>=0;n-=1){const r=s[n],i=Object.assign(Object.assign({},e),d.ObjectExt.pick(r.options,this.options.revertOptionsList||[]));this.executeCommand(r,!0,i)}this.freezed=!1}applyCommand(t,e){this.freezed=!0;const s=Array.isArray(t)?l.sortBatchCommands(t):[t];for(let n=0;n<s.length;n+=1){const r=s[n],i=Object.assign(Object.assign({},e),d.ObjectExt.pick(r.options,this.options.applyOptionsList||[]));this.executeCommand(r,!1,i)}this.freezed=!1}executeCommand(t,e,s){const n=this.model,r=n.getCell(t.data.id),i=t.event;if(l.isAddEvent(i)&&e||l.isRemoveEvent(i)&&!e)r&&r.remove(s);else if(l.isAddEvent(i)&&!e||l.isRemoveEvent(i)&&e){const a=t.data;a.node?n.addNode(a.props,s):a.edge&&n.addEdge(a.props,s)}else if(l.isChangeEvent(i)){const a=t.data,o=a.key;if(o&&r){const f=e?a.prev[o]:a.next[o];a.key==="attrs"&&this.ensureUndefinedAttrs(f,e?a.next[o]:a.prev[o])&&(s.dirty=!0),r.prop(o,f,s)}}else{const a=this.options.executeCommand;a&&d.FunctionExt.call(a,this,t,e,s)}}addCommand(t,e){if(this.freezed||this.disabled)return;const s=e,n=s.options||{};if(n.dryrun||l.isAddEvent(t)&&this.options.ignoreAdd||l.isRemoveEvent(t)&&this.options.ignoreRemove||l.isChangeEvent(t)&&this.options.ignoreChange)return;const r=this.options.beforeAddCommand;if(r!=null&&d.FunctionExt.call(r,this,t,e)===!1)return;t==="cell:change:*"&&(t=`cell:change:${s.key}`);const i=s.cell,a=d.Model.isModel(i);let o;if(this.batchCommands){o=this.batchCommands[Math.max(this.lastBatchIndex,0)];const c=a&&!o.modelChange||o.data.id!==i.id,u=o.event!==t;if(this.lastBatchIndex>=0&&(c||u)){const m=this.batchCommands.findIndex(p=>(a&&p.modelChange||p.data.id===i.id)&&p.event===t);m<0||l.isAddEvent(t)||l.isRemoveEvent(t)?o=this.createCommand({batch:!0}):(o=this.batchCommands[m],this.batchCommands.splice(m,1)),this.batchCommands.push(o),this.lastBatchIndex=this.batchCommands.length-1}}else o=this.createCommand({batch:!1});if(l.isAddEvent(t)||l.isRemoveEvent(t)){const c=o.data;return o.event=t,o.options=n,c.id=i.id,c.props=d.ObjectExt.cloneDeep(i.toJSON()),i.isEdge()?c.edge=!0:i.isNode()&&(c.node=!0),this.push(o,n)}if(l.isChangeEvent(t)){const c=e.key,u=o.data;return(!o.batch||!o.event)&&(o.event=t,o.options=n,u.key=c,u.prev==null&&(u.prev={}),u.prev[c]=d.ObjectExt.cloneDeep(i.previous(c)),a?o.modelChange=!0:u.id=i.id),u.next==null&&(u.next={}),u.next[c]=d.ObjectExt.cloneDeep(i.prop(c)),this.push(o,n)}const f=this.options.afterAddCommand;f&&d.FunctionExt.call(f,this,t,e,o),this.push(o,n)}initBatchCommand(t){this.freezed||(this.batchCommands?this.batchLevel+=1:(this.batchCommands=[this.createCommand({batch:!0})],this.batchLevel=0,this.lastBatchIndex=-1))}storeBatchCommand(t){if(!this.freezed)if(this.batchCommands&&this.batchLevel<=0){const e=this.filterBatchCommand(this.batchCommands);e.length>0&&(this.redoStack=[],this.undoStackPush(e),this.consolidateCommands(),this.notify("add",e,t)),this.batchCommands=null,this.lastBatchIndex=-1,this.batchLevel=0}else this.batchCommands&&this.batchLevel>0&&(this.batchLevel-=1)}filterBatchCommand(t){let e=t.slice();const s=[];for(;e.length>0;){const n=e.shift(),r=n.event,i=n.data.id;if(r!=null&&(i!=null||n.modelChange)){if(l.isAddEvent(r)){const a=e.findIndex(o=>l.isRemoveEvent(o.event)&&o.data.id===i);if(a>=0){e=e.filter((o,f)=>a<f||o.data.id!==i);continue}}else if(l.isRemoveEvent(r)){const a=e.findIndex(o=>l.isAddEvent(o.event)&&o.data.id===i);if(a>=0){e.splice(a,1);continue}}else if(l.isChangeEvent(r)){const a=n.data;if(d.ObjectExt.isEqual(a.prev,a.next))continue}s.push(n)}}return s}notify(t,e,s){const n=e==null?null:Array.isArray(e)?e:[e];this.emit(t,{cmds:n,options:s}),this.graph.trigger(`history:${t}`,{cmds:n,options:s}),this.emit("change",{cmds:n,options:s}),this.graph.trigger("history:change",{cmds:n,options:s})}push(t,e){this.redoStack=[],t.batch?(this.lastBatchIndex=Math.max(this.lastBatchIndex,0),this.emit("batch",{cmd:t,options:e})):(this.undoStackPush(t),this.consolidateCommands(),this.notify("add",t,e))}consolidateCommands(){var t;const e=this.undoStack[this.undoStack.length-1],s=this.undoStack[this.undoStack.length-2];if(!Array.isArray(e))return;const n=new Set(e.map(i=>i.event));if(n.size!==2||!n.has("cell:change:parent")||!n.has("cell:change:children")||!e.every(i=>{var a;return i.batch&&((a=i.options)===null||a===void 0?void 0:a.ui)})||!Array.isArray(s)||s.length!==1)return;const r=s[0];r.event!=="cell:change:position"||!(!((t=r.options)===null||t===void 0)&&t.ui)||(s.push(...e),this.undoStack.pop())}undoStackPush(t){if(this.stackSize===0){this.undoStack.push(t);return}this.undoStack.length>=this.stackSize&&this.undoStack.shift(),this.undoStack.push(t)}ensureUndefinedAttrs(t,e){let s=!1;return t!==null&&e!==null&&typeof t=="object"&&typeof e=="object"&&Object.keys(e).forEach(n=>{t[n]===void 0&&e[n]!==void 0?(t[n]=void 0,s=!0):typeof t[n]=="object"&&typeof e[n]=="object"&&(s=this.ensureUndefinedAttrs(t[n],e[n]))}),s}dispose(){this.validator.dispose(),this.clean(),this.stopListening(),this.off()}}y([d.Basecoat.dispose()],g.prototype,"dispose",null);(function(h){class t extends d.Basecoat{constructor(s){super(),this.map={},this.command=s.history,this.cancelInvalid=s.cancelInvalid!==!1,this.command.on("add",this.onCommandAdded,this)}onCommandAdded({cmds:s}){return Array.isArray(s)?s.every(n=>this.isValidCommand(n)):this.isValidCommand(s)}isValidCommand(s){if(s.options&&s.options.validation===!1)return!0;const n=s.event&&this.map[s.event]||[];let r=null;return n.forEach(i=>{let a=0;const o=f=>{const c=i[a];a+=1;try{if(c)c(f,s,o);else{r=f;return}}catch(u){o(u)}};o(r)}),r?(this.cancelInvalid&&this.command.cancel(),this.emit("invalid",{err:r}),!1):!0}validate(s,...n){const r=Array.isArray(s)?s:s.split(/\s+/);return n.forEach(i=>{if(typeof i!="function")throw new Error(`${r.join(" ")} requires callback functions.`)}),r.forEach(i=>{this.map[i]==null&&(this.map[i]=[]),this.map[i].push(n)}),this}dispose(){this.command.off("add",this.onCommandAdded,this)}}y([d.Basecoat.dispose()],t.prototype,"dispose",null),h.Validator=t})(g||(g={}));var l;(function(h){function t(i){return i==="cell:added"}h.isAddEvent=t;function e(i){return i==="cell:removed"}h.isRemoveEvent=e;function s(i){return i!=null&&i.startsWith("cell:change:")}h.isChangeEvent=s;function n(i){const a=["cell:added","cell:removed","cell:change:*"],o=["batch:start","batch:stop"],f=i.eventNames?i.eventNames.filter(c=>!(h.isChangeEvent(c)||a.includes(c)||o.includes(c))):a;return Object.assign(Object.assign({enabled:!0},i),{eventNames:f,applyOptionsList:i.applyOptionsList||["propertyPath"],revertOptionsList:i.revertOptionsList||["propertyPath"]})}h.getOptions=n;function r(i){const a=[];for(let o=0,f=i.length;o<f;o+=1){const c=i[o];let u=null;if(h.isAddEvent(c.event)){const m=c.data.id;for(let p=0;p<o;p+=1)if(i[p].data.id===m){u=p;break}}u!==null?a.splice(u,0,c):a.push(c)}return a}h.sortBatchCommands=r})(l||(l={}));export{g as H};

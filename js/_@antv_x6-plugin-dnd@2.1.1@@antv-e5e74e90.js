import{l as d}from"./_@antv_x6@2.18.1@@antv-4eec9d0e.js";const f=`.x6-widget-dnd {
  position: absolute;
  top: -10000px;
  left: -10000px;
  z-index: 999999;
  display: none;
  cursor: move;
  opacity: 0.7;
  pointer-events: 'cursor';
}
.x6-widget-dnd.dragging {
  display: inline-block;
}
.x6-widget-dnd.dragging * {
  pointer-events: none !important;
}
.x6-widget-dnd .x6-graph {
  background: transparent;
  box-shadow: none;
}
`;var m=globalThis&&globalThis.__decorate||function(c,e,i,t){var n=arguments.length,s=n<3?e:t===null?t=Object.getOwnPropertyDescriptor(e,i):t,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(c,e,i,t);else for(var o=c.length-1;o>=0;o--)(a=c[o])&&(s=(n<3?a(s):n>3?a(e,i,s):a(e,i))||s);return n>3&&s&&Object.defineProperty(e,i,s),s};class p extends d.View{get targetScroller(){return this.options.target.getPlugin("scroller")}get targetGraph(){return this.options.target}get targetModel(){return this.targetGraph.model}get snapline(){return this.options.target.getPlugin("snapline")}constructor(e){super(),this.name="dnd",this.options=Object.assign(Object.assign({},p.defaults),e),this.init()}init(){d.CssLoader.ensure(this.name,f),this.container=document.createElement("div"),d.Dom.addClass(this.container,this.prefixClassName("widget-dnd")),this.draggingGraph=new d.Graph(Object.assign(Object.assign({},this.options.delegateGraphOptions),{container:document.createElement("div"),width:1,height:1,async:!1})),d.Dom.append(this.container,this.draggingGraph.container)}start(e,i){const t=i;t.preventDefault(),this.targetModel.startBatch("dnd"),d.Dom.addClass(this.container,"dragging"),d.Dom.appendTo(this.container,this.options.draggingContainer||document.body),this.sourceNode=e,this.prepareDragging(e,t.clientX,t.clientY);const n=this.updateNodePosition(t.clientX,t.clientY);this.isSnaplineEnabled()&&(this.snapline.captureCursorOffset({e:t,node:e,cell:e,view:this.draggingView,x:n.x,y:n.y}),this.draggingNode.on("change:position",this.snap,this)),this.delegateDocumentEvents(p.documentEvents,t.data)}isSnaplineEnabled(){return this.snapline&&this.snapline.isEnabled()}prepareDragging(e,i,t){const n=this.draggingGraph,s=n.model,a=this.options.getDragNode(e,{sourceNode:e,draggingGraph:n,targetGraph:this.targetGraph});a.position(0,0);let o=5;if(this.isSnaplineEnabled()&&(o+=this.snapline.options.tolerance||0),this.isSnaplineEnabled()||this.options.scaled){const l=this.targetGraph.transform.getScale();n.scale(l.sx,l.sy),o*=Math.max(l.sx,l.sy)}else n.scale(1,1);this.clearDragging(),s.resetCells([a]);const r=n.findViewByCell(a);r.undelegateEvents(),r.cell.off("changed"),n.fitToContent({padding:o,allowNewOrigin:"any",useCellGeometry:!1});const g=r.getBBox();this.geometryBBox=r.getBBox({useCellGeometry:!0}),this.delta=this.geometryBBox.getTopLeft().diff(g.getTopLeft()),this.draggingNode=a,this.draggingView=r,this.draggingBBox=a.getBBox(),this.padding=o,this.originOffset=this.updateGraphPosition(i,t)}updateGraphPosition(e,i){const t=document.body.scrollTop||document.documentElement.scrollTop,n=document.body.scrollLeft||document.documentElement.scrollLeft,s=this.delta,a=this.geometryBBox,o=this.padding||5,r={left:e-s.x-a.width/2-o+n,top:i-s.y-a.height/2-o+t};return this.draggingGraph&&d.Dom.css(this.container,{left:`${r.left}px`,top:`${r.top}px`}),r}updateNodePosition(e,i){const t=this.targetGraph.clientToLocal(e,i),n=this.draggingBBox;return t.x-=n.width/2,t.y-=n.height/2,this.draggingNode.position(t.x,t.y),t}snap({cell:e,current:i,options:t}){const n=e;if(t.snapped){const s=this.draggingBBox;n.position(s.x+t.tx,s.y+t.ty,{silent:!0}),this.draggingView.translate(),n.position(i.x,i.y,{silent:!0}),this.snapOffset={x:t.tx,y:t.ty}}else this.snapOffset=null}onDragging(e){const i=this.draggingView;if(i){e.preventDefault();const t=this.normalizeEvent(e),n=t.clientX,s=t.clientY;this.updateGraphPosition(n,s);const a=this.updateNodePosition(n,s),o=this.targetGraph.options.embedding.enabled,r=(o||this.isSnaplineEnabled())&&this.isInsideValidArea({x:n,y:s});if(o){i.setEventData(t,{graph:this.targetGraph,candidateEmbedView:this.candidateEmbedView});const g=i.getEventData(t);r?i.processEmbedding(t,g):i.clearEmbedding(g),this.candidateEmbedView=g.candidateEmbedView}this.isSnaplineEnabled()&&(r?this.snapline.snapOnMoving({e:t,view:i,x:a.x,y:a.y}):this.snapline.hide())}}onDragEnd(e){const i=this.draggingNode;if(i){const t=this.normalizeEvent(e),n=this.draggingView,s=this.draggingBBox,a=this.snapOffset;let o=s.x,r=s.y;a&&(o+=a.x,r+=a.y),i.position(o,r,{silent:!0});const g=this.drop(i,{x:t.clientX,y:t.clientY}),l=h=>{h?(this.onDropped(i),this.targetGraph.options.embedding.enabled&&n&&(n.setEventData(t,{cell:h,graph:this.targetGraph,candidateEmbedView:this.candidateEmbedView}),n.finalizeEmbedding(t,n.getEventData(t)))):this.onDropInvalid(),this.candidateEmbedView=null,this.targetModel.stopBatch("dnd")};d.FunctionExt.isAsync(g)?(this.undelegateDocumentEvents(),g.then(l)):l(g)}}clearDragging(){this.draggingNode&&(this.sourceNode=null,this.draggingNode.remove(),this.draggingNode=null,this.draggingView=null,this.delta=null,this.padding=null,this.snapOffset=null,this.originOffset=null,this.undelegateDocumentEvents())}onDropped(e){this.draggingNode===e&&(this.clearDragging(),d.Dom.removeClass(this.container,"dragging"),d.Dom.remove(this.container))}onDropInvalid(){const e=this.draggingNode;e&&this.onDropped(e)}isInsideValidArea(e){let i,t=null;const n=this.targetGraph,s=this.targetScroller;this.options.dndContainer&&(t=this.getDropArea(this.options.dndContainer));const a=t&&t.containsPoint(e);if(s)if(s.options.autoResize)i=this.getDropArea(s.container);else{const o=this.getDropArea(s.container);i=this.getDropArea(n.container).intersectsWithRect(o)}else i=this.getDropArea(n.container);return!a&&i&&i.containsPoint(e)}getDropArea(e){const i=d.Dom.offset(e),t=document.body.scrollTop||document.documentElement.scrollTop,n=document.body.scrollLeft||document.documentElement.scrollLeft;return d.Rectangle.create({x:i.left+parseInt(d.Dom.css(e,"border-left-width"),10)-n,y:i.top+parseInt(d.Dom.css(e,"border-top-width"),10)-t,width:e.clientWidth,height:e.clientHeight})}drop(e,i){if(this.isInsideValidArea(i)){const t=this.targetGraph,n=t.model,s=t.clientToLocal(i),a=this.sourceNode,o=this.options.getDropNode(e,{sourceNode:a,draggingNode:e,targetGraph:this.targetGraph,draggingGraph:this.draggingGraph}),r=o.getBBox();s.x+=r.x-r.width/2,s.y+=r.y-r.height/2;const g=this.snapOffset?1:t.getGridSize();o.position(d.GeometryUtil.snapToGrid(s.x,g),d.GeometryUtil.snapToGrid(s.y,g)),o.removeZIndex();const l=this.options.validateNode,h=l?l(o,{sourceNode:a,draggingNode:e,droppingNode:o,targetGraph:t,draggingGraph:this.draggingGraph}):!0;return typeof h=="boolean"?h?(n.addCell(o,{stencil:this.cid}),o):null:d.FunctionExt.toDeferredBoolean(h).then(u=>u?(n.addCell(o,{stencil:this.cid}),o):null)}return null}onRemove(){this.draggingGraph&&(this.draggingGraph.view.remove(),this.draggingGraph.dispose())}dispose(){this.remove(),d.CssLoader.clean(this.name)}}m([d.View.dispose()],p.prototype,"dispose",null);(function(c){c.defaults={getDragNode:e=>e.clone(),getDropNode:e=>e.clone()},c.documentEvents={mousemove:"onDragging",touchmove:"onDragging",mouseup:"onDragEnd",touchend:"onDragEnd",touchcancel:"onDragEnd"}})(p||(p={}));export{p as D};
